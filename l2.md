# L2. Вопросы масштабирования
## Мотивационная

Ончейн-активность растет с невероятной скоростью, а вместе с ней и спрос на блочное пространство. На фоне страданий Ethereum в последние пару лет, мы наблюдали, как другие сети Л1 и Л2 набирают свой вес и становятся популярными. Другими словами началась конкуренция в масштабируемости. Массово в обиход были введены новые термины, такие как парачейны, сайдчейны, мосты, зоны, шардинг, роллапы, data availability и многие другие.

#### Определимся с терминологией. В этом эссе:

* Масштабируемость - это возможность обрабатывать больше транзакций без увеличения стоимости их валидации. 
* Компонуемость относится к способности приложений беспрепятственно взаимодействовать друг с другом с минимальным "трением"
* Модульность - это возможность разбить систему на несколько отдельных частей (модулей), которые можно повторно использовать, компонуя исходя из требований

При таком подходе нельзя рассматривать сайдчейны и каналы как легальные стратегии масштабирования, но комментарий приведу

#### Пара слов о компромиссах в контексте решений масштабируемости, на которые стоит обращать внимание:

- Безопасность в этом контексте можно определить как цену «обмануть систему». Как в физическом, так и в цифровом плане безопасность относится к ресурсам, выделенным для защиты цепи.
- Расходы. Довольно просто: стоимость транзакции. Для инфраструктуры блокчейна стоимость транзакций в основном состоит из стоимости обеспечения пропускной способности и стоимости хранения данных.
- Эффективность - это количество работы или ресурсов по отношению к равному результату. Например, блокчейн, который требует проверки от 100 валидаторов из 100, гораздо менее эффективен, чем тот, который требует проверки от 51 из 100. Часто это качество влияет на стоимость.
- Конфиденциальность. Степень сокрытия информации о транзакции от "заинтересованной" общественности.
- Доверие - достаточно размытое качество. Во вселенной криптоактивов обычно сводится к тому, основана ли надежность механизма на математике или экономике. И если основана на экономике, насколько разумны допущения?

[Fraud and Data Availability Proofs: Maximising Light Client Security and Scaling Blockchains with Dishonest Majorities](https://arxiv.org/abs/1809.09044)

## Монолит

Начнем пожалуй с монолитных блокчейнов. Согласно этому критерию, Polygon PoS и BSC не соответствуют нашему определению масштабируемости, поскольку они увеличивают пропускную способность за счет больших размеров блока — хорошо известный компромисс(bitcoin cash для примера), который увеличивает потребность узлов в ресурсах и жертвует децентрализацией ради повышения производительности. Хотя эта стратегия решает ряд проблем в моменте, она менее привлекательна в качестве долгосрочного решения. Исходя из этого тот же Polygon переходит к более устойчивому решению, основанному на роллапах.

Солана, с другой стороны, представляет собой попытку раздвинуть границы предоставив полностью компонуемый монолитный блокчейн. Секретный ингридиент Соланы это Proof of History (PoH) реестр. Идея PoH состоит в том, чтобы создать глобальное понятие времени — глобальные часы — с помощью которых все транзакции, включая голосование за консенсус, имеют надежные временные метки, прикрепленные эмитентом. Эти метки позволяют узлам двигаться вперед, не дожидаясь синхронизации друг с другом в каждом блоке. Solana к тому же дополняет эту возможность, оптимизируя свою среду выполнения для параллельной обработки транзакций батчами, а не по одной, как в случае EVM, для достижения большей масштабируемости.

Несмотря на то, что прирост пропускной способности Solana выходит за рамки того, что может быть достигнуто простой настройкой параметров, он по-прежнему в значительной степени связан с более интенсивным использованием оборудования и пропускной способности сети. Хотя это снижает плату для пользователей, но серьезно ограничивает операции обработки данных нодами. Это контрастирует с Ethereum, который, хотя и недоступен для многих из-за непомерных комиссий, в конечном итоге позволяет запускать ноды из дома.

Масштабируемость при подобном подходе в конечном итоге ограничена тем, сколько транзакций может обрабатывать один узел. Независимо от субъективных мнений о децентрализации(и будем честны она не во всех задачах требуется), эту способность можно утилизировать достаточно сильно, прежде чем управление сконцентрируется в руках относительно небольшого числа участников. Напротив, модульные цепочки распределяют общую работу между различными узлами, так что общая пропускная способность может быть больше, чем может обработать любой отдельный узел. Но не стоит забывать о сложностях с согласованием и повышенной стоимости для больших объемов данных/транзакций. Для массивных вычислений, числодробилок и mpc

Важно отметить, что децентрализация — это лишь половина картины модульности. Другая важная сторона - это эффективное ценообразование на ресурсы (т.е. сборы и коми). В монолитной цепочке все транзакции конкурируют за одно и то же пространство в блоках и потребляют одни и те же ресурсы. Естественно, в сценариях, когда сеть становится переполненной, чрезмерный спрос на одно приложение имеет неблагоприятные последствия для всех приложений в сети, поскольку плата растет для всех. Это стало реальностью Ethereum с тех пор, как CryptoKitties засорили сеть в 2017 году. Отметим, что дополнительная пропускная способность никогда не решает проблему раз и навсегда — она просто откладывает ее. Гейтс(не точно) когда-то говорил, что 640кб хватит всем.

Наконец, монолитная цепочка просто не может оптимизировать себя для самых разных приложений с разными приоритетами. В случае Соланы одним из примером служит [кейс]((https://forums.solana.com/t/proposal-for-a-temporary-one-off-code-change-to-reduce-the-skyrocketing-costs-of-rent/1572) Kin. Низкие задержки Solana подходят для таких приложений, как Serum DEX. Однако поддержание такого "равновесия" между tps и коми также требует ограничения на рост состояния(state). В свою очередь, оказывает негативное влияние на приложения с большим объемом учетных записей, такие как Kin, которые не могут предложить пропускную способность Solana широким массам из-за высоких комиссий.


## Модульные подходы

В перспективе наивно ожидать, что единый пул ресурсов будет надежно поддерживать широкий спектр криптографических приложений; метаверсы, игры, DeFi, платежи. Хотя увеличение пропускной способности полностью компонуемой цепочки полезно, нам нужно более широкое пространство для проектирования и лучшие цены на ресурсы для массового внедрения. Здесь в игру вступают модульные подходы.

Ethereum Rollups, ETH 2.0 Shards, Cosmos Zones, Polkadot Parachains, Avalanche Subnets, чанки в Near и Algorand Co-Chains — все это можно рассматривать как примеры. Каждый обрабатывает подмножество общей нагрузки в соответствующих экосистемах, сохраняя при этом возможность кросс-взаимодействия. Копнув глубже заметим, что модульные конструкции сильно различаются в зависимости от того, как они подходят к обеспечению безопасности между модулями. Многоцепочечные хабы, такие как Avalanche, Cosmos и Algorand, больше всего подходят для модулей с независимой защитой, тогда как Ethereum, Polkadot, Near предусматривают модули, которые в конечном итоге разделяют или наследуют безопасность друг от друга.

## Multi-Chain / Multi-Network Hubs

Простейшая модульная конструкция известна как хабы для взаимодействия(прямая калька с клиент-серверных приложений). Подобная архитектура описывает несколько цепочек/сетей, которые взаимодействуют друг с другом через стандартизированные протоколы. Хабы обеспечивают более широкое пространство для проектирования, поскольку они могут иметь цепочки для конкретных приложений, настроенные на многих различных уровнях(разные виртуальные машины, требования к узлу, модели оплаты и гавернанс). Гибкость цепочки приложений при таком подходе не может сравниться со смарт-контрактами в цепочке общего назначения. 

#### Приведу лишь несколько примеров для иллюстрации:
* Terra. Имеет специальную модель комиссий и инфляции, оптимизированную для "стабилизации" своих токенов
* Кроссчейн DEX Osmosis, который шифрует свои транзакции до завершения, чтобы предотвратить фронт-ран
* Algorand и Avalanche. Нацелены на размещение корпоративных вариантов использования в пользовательских сетях. Они могут варьироваться от CBDC, управляемой государственными учреждениями, до игровой сети, управляемой комитетом игровых компаний. Важно отметить, что пропускная способность таких сетей может быть увеличена за счет более мощных машин без ущерба для уровня децентрализации других сетей/цепочек.

Хабы-концентраторы предлагают преимущества масштабируемости в той мере, в какой они обеспечивают более эффективное использование ресурсов. Рассмотрим Аваланч в качестве примера. C-Chain предназначен для смарт-контрактов, совместимых с EVM, а X-Chain — для платежей P2P. Поскольку платежи часто могут быть независимыми друг от друга, X-Chain может одновременно обрабатывать различные виды транзакций, разделяя виртуальные машины на основе их основной функции.

Экосистемы, разделяющие данный подход, также могут вертикально масштабироваться за счет фундаментальных инноваций. Avalanche и Algorand особенно выделяются здесь, поскольку они достигают более высокого масштаба за счет снижения коммуникационных издержек консенсуса. Avalanche делает это с помощью процесса «sub-sampled voting», в то время как Algorand использует дешевый VRF для узлов, чтобы случайным образом выбрать уникальный кворум для достижения консенсуса по каждому блоку.

Но до сих пор мы изложили преимущества хабов. Поговорим о недостатках и ограничениях. Наиболее очевидным ограничением является необходимость для цепей обеспечивать собственную безопасность, поскольку они не могут делиться или наследовать безопасность друг от друга. К настоящему времени известно, что любая безопасная межсетевая связь требует доверенной третьей стороны или предположения о синхронности. В случае хабов доверенная третья сторона становится мажоритарным валидатором цепочки контрагентов.

Например, токен, привязанный от одной цепочки к другой через IBC, всегда может быть выкуплен (украден) злонамеренным большинством валидаторов исходной цепочки. Это предположение о доверии большинства может хорошо работать сегодня, когда сосуществует лишь несколько сетей. Однако в возможном будущем, когда существует длинный хвост цепочек/сетей, ожидать, что эти цепочки/сети будут доверять валидаторам друг друга в общении или совместном использовании ликвидности, далеко не идеально. Это приводит нас к свертыванию данных и шардингу, которые предлагают кросс-коммуникации с более сильными гарантиями, выходящим за рамки предположений о доверии большинства.

## Data Availability(DA)

После многих лет пота и слез решили, что все усилия по обеспечению безопасности сводятся к очень тонкой проблеме, называемой доступностью данных. Чтобы понять почему, рассмотрим работу узлов в типовом блокчейне.

Полные ноды загружают и проверяют все транзакции, в то время как "легкие" ноды, у которых нет необходимых ресурсов для интенсивного аудита (99% пользователей), проверяют только заголовки блоков (зафиксированные большинством валидаторов). Таким образом, в то время как полные узлы могут независимо обнаруживать и отклонять недействительные транзакции (например, неограниченное количество выпущенных токенов), легкие узлы считают все, что совершает большинство, действительной транзакцией.

Чтобы улучшить это, в идеале любой отдельный полный узел может защитить все легкие узлы, выдавая доказательства небольшого размера. При таком дизайне легкие узлы могут работать с теми же гарантиями безопасности, что и полные узлы, не затрачивая столько же ресурсов. Однако это вводит новую проблему, известную как DA.

Если злонастроенные валидаторы публикуют заголовок, но при этом удерживают некоторые или все транзакции в блоке, полные ноды не смогут определить, действителен ли блок, потому что отсутствующие транзакции могут быть недействительными или вызвать двойную трату. Без этих знаний полные узлы не могут создать защиту от мошенничества для защиты легких узлов. Таким образом, чтобы механизм защиты работал, в первую очередь легкие узлы должны убедиться, что валидаторы предоставили полный и полный список всех транзакций.

Проблема DA — неотъемлемая часть модульных архитектур, стремящихся выйти за рамки предположений о простом доверии большинству, когда речь идет о кросс-коммуникациях. Что делает роллапы особенными среди L2, так это то, что они не пытаются обойти эту проблему.

## Rollups

В этом примере address_x покупает NFT токен. Этот NFT может иметь сложные атрибуты. Например, этот может быть продуктом с фиксированным доходом, по которому начисляются проценты (например, BarnBridge), опционным контрактом с очень специфическими параметрами и функциями (например, Opyn) или произведением искусства, которое дает художнику гонорары при совершении сделки. Вся эта функциональность, которая в первую очередь делает гипотетическую NFT полезной, также делает ее «тяжелее» и, следовательно, более дорогой для транзакций. Роллапы позволяют нам выполнять эту тяжелую работу вне сети и кратко сообщать об изменениях обратно в цепочку после завершения вычислений, разделяя безопасность базового уровня сети (например, основной сетью Ethereum), что затрудняет атаку на них.

В то время как сайд-чейны(как концепция) относительно легко усваиваются, другие решения масштабирования могут быть концептуально более интересными. 

В контексте Роллапов мы можем думать об основной цепочке (Ethereum) как о легком узле для "свертывания" (например Arbitrum). Свертки размещают все данные своих транзакций на L1, чтобы любой узел L1 мог выполнить их и воссоздать состояние роллапа с нуля. Имея под рукой полное состояние, любой клиент может перевести виртуальную машину в новое состояние и доказать правильность перехода, выдав подтверждение о достоверности/мошенничестве. Наличие данных, доступных в основной цепочке, позволяет сверткам работать исходя из предположения об одном честном узле вместо честного большинства.

#### Примите во внимание следующее. Как роллапы обеспечивают лучшую масштабируемость при таком дизайне:

- Поскольку любой отдельный узел с текущим состоянием может защитить все остальные без этого состояния, централизация узлов свертки представляет меньший риск, и поэтому блоки свертки можно сделать достаточно большими.
- Несмотря на то, что все узлы L1 загружают данные свертки в отношении своих транзакций, только часть из них выполняет эти транзакции и создает состояние свертки, тем самым снижая общее потребление ресурсов.
- Данные сводки сжимаются с использованием хитрых методов перед размещением на уровне L1.
- Подобно цепочкам приложений, накопительные пакеты могут адаптировать свои виртуальные машины для конкретных случаев использования, что подразумевает более эффективное использование ресурсов.

#### На данный момент существует пять категорий роллапов:

- ZK rollups(DyDx, Loopring, ZKSwapV2, Aztec, ZKSpace, ZKSync, Polygon Hermez, StarkNet)
- Validium(Immutable X, DeversiFi, Sorare)
- Volitions(ZKSync V2)
- Optimistic rollups(Arbitrum, Optimism, Boba Network, Metis, Layer2.Finance, Habitat, Fuel v1)
- Plasma(Omg Network, Gluon)

Несмотря на то, что в роллапах применяются хитрые методы сжатия данных, данные все равно должны быть отправлены на все узлы L1. Поэтому накопительные пакеты могут предложить только линейную выгоду масштабируемости и ограничены в том, насколько они могут снизить плату за пользование. На них также сильно влияет волатильность цены на газ. Для устойчивого масштабирования Ethereum необходимо масштабировать свою емкость данных, что объясняет необходимость в шардинге Ethereum.

[(Almost) Everything you need to know about Optimistic Rollup – Paradigm](https://research.paradigm.xyz/rollups)

## ZK-rollups

С точки зрения масштабируемости ZK-свертки более выгодны, чем оптимистичные, потому что они сжимают данные более эффективным способом, благодаря чему достигается значительно меньшая площадь "слепка" состояния на L1 для определенных случаев использования. Этот нюанс уже наблюдается на практике. В то время как Optimism отправляет данные в L1 для отражения каждой транзакции, dYdX публикует их для отражения каждого баланса счета. Таким образом, объем L1 dYdX составляет 1/5 от Optimism, и по оценкам, он утилизирует примерно в 10 раз большую пропускную способность. Это преимущество естественным образом приводит к снижению комиссий за ZK-роллапы.

Сводки с нулевым разглашением (zkr) выполняют вычисления вне цепочки, а затем используют zk-доказательства для сжатия данных выполнения в роллап. Для удобоваримого объяснения того, как работают zk-доказательства, предлагаю ознакомиться с «Как объяснить детям протоколы с нулевым разглашением»(http://pages.cs.wisc.edu/~mkowalcz/628.pdf). 

Поскольку верификатор в zk-proofs требует минимальной информации, эта технология отлично подходит для эффективного хранения данных, что приводит к снижению транзакционных издержек и быстрой обработке транзакций. Однако сложность разработки zk-доказательств ограничивает функциональность ZK-роллапов. Zk-доказательства — это передовая математика, и в своем нынешнем состоянии эта технология лучше всего подходит для простых транзакций.

В zk-роллапах данные доступны on-chain, что может быть невыгодно, если вашими приоритетами являются (а)конфиденциальность или (б)эффективность. Однако, если вам нужна (в)надежность или (г)большая безопасность, вы, вероятно, выберете данный подход.

Примитивный Флоу:
Схема ZK-Rollup состоит из двух типов пользователей: транзакторы и ретрансляторы. Первые создают свои переводы и транслируют их в сеть. Данные о передаче состоят из проиндексированных адресов «куда» и «от», значения транзакции, платы за газ и одноразового nonce. Укороченная 3-байтовая индексированная версия адресов снижает потребность в ресурсах обработки. Значение транзакции больше или меньше нуля создает депозит или снятие средств соответственно. Смарт-контракт записывает данные в два дерева Меркла; адреса в одном и суммы перевода в другом.

Ретрансляторы собирают большое количество переводов для создания сводки-агрегата. Работа ретрансляторов заключается в создании доказательства SNARK. Если просто, то это хеш, представляющий дельту состояния блокчейна. Доказательство SNARK сравнивает моментальный снимок блокчейна до передачи с моментальным снимком цепочки блоков после передачи (т.е. значения кошелька) и сообщает в основную сеть только об изменениях в поддающемся проверке хэше.
Стоит отметить, что любой может стать ретранслятором, если он "застейкал" в смарт-контракт. Это побуждает ретранслятора не вмешиваться в свертки и не задерживать их.

Еще к трудностям следует отнести сложность оптимизации данных для получения максимальной пропускной способности, первоначальная настройка ZK-Rollups централизована и предполагается "непроверяемое" доверие. Небольшая группа разработчиков будет экспертами по начальному доверенному состоянию. + повышается риск хакерских атак с использованием социальной инженерии, убеждая разработчика манипулировать кодом или предоставлять информацию об уязвимостях. Вопрос о Снарках и Квантовых вычислениях  достаточно спекулятивен и лежит вне темы эссе.

#### Почитать-посмотреть:

[Zero Knowledge Proof - Video Overview](https://youtu.be/0Sy6nb72gCk)

[zkSNARKs in a nutshell](https://blog.ethereum.org/2016/12/05/zksnarks-in-a-nutshell/)

[On-chain scaling to potentially ~500tx/sec through mass tx validation](https://ethresear.ch/t/on-chain-scaling-to-potentially-500-tx-sec-through-mass-tx-validation/3477)

[ZK Rollup & Optimistic Rollup](https://medium.com/coinmonks/zk-rollup-optimistic-rollup-70c01295231b)

[On-chain scaling with full data availability. Moving verification of chains off-chain?](https://ethresear.ch/t/on-chain-scaling-with-full-data-availability-moving-verification-of-transactions-off-chain/3847)

[Moving verification of chains off-chain?](https://ethresear.ch/t/on-chain-scaling-with-full-data-availability-moving-verification-of-transactions-off-chain/3847)

## Volitions + Validium

В отличие от защиты от мошенничества в Optimistic роллапах, доказательства достоверности в ZK-роллапах также позволяют использовать более свежее масштабируемое решение, известное как volition. Хотя полные эффекты волеизъявления еще предстоит увидеть, они кажутся очень многообещающими, поскольку дают пользователям свободу решить, публиковать ли данные в сети или вне сети. Выбор пользователем уровеня безопасности для каждой транзакции. И zkSync, и Starkware имеют добровольные реализации для желающих.
Некоторые приложения, такие как децентрализованные биржи деривативов, могут предпочесть именно это решение, если захотят быть совместимыми с приложениями в ZK-роллапах. Плюс относительная простота переключения между решениями

Validium могут показаться сложными, но не нужно их переоценивать. Они идентичны zk-роллапам, данные хранятся вне цепочки. Основное различие между ними заключается в доступности данных. Starkware полагается на комитеты по доступности данных (DAC), для обеспечения нейтрального и честного хранения данных. Как и в случае с zk-rollups, в то время как вредоносный узел (узлы) может остановить решение валидации, они не могут украсть средства, потому что validium является доказательством достоверности. Если средства будут украдены, доказательство будет недействительным. Это резко уменьшает вектор атаки. Основным недостатком validium является то, что базовые данные могут быть отключены или недоступны в течение длительных периодов времени. Будут описаны более подробно

[Volition and the Emerging Data Availability spectrum – StarkWare](https://medium.com/starkware/volition-and-the-emerging-data-availability-spectrum-87e8bfa09bb)

[The Self-Custody Series, Part IV – Data Availability – StarkWare](https://medium.com/starkware/data-availability-e5564c416424)

## Optimistic-rollups

В то время как zk-свертки полагаются исключительно на математику для обеспечения доверия, оптимистичные свертывания частично полагаются на экономику. Оптимистичные свертки по умолчанию предполагают, что все транзакции действительны. Если транзакция недействительна, любой узел может "бросить вызов" роллапу и получить вознаграждение, и наказать злонамеренный узел. Некоторые считают подобную структуру стимулирования/дестимулирования достаточной.

Подобное предположение называется предположением об «одном честном узле», потому что для того, чтобы оно было верным, вам нужен только один честный узел, а не большинство (что имеет место для протоколов Л1). В отличие от zk-свертывания, на самом деле нет текущих ограничений относительно того, какие действия вы можете выполнять с оптимистичными роллапами. Однако у оптимистической модели есть два заметных недостатка:
- Сжатие данных хуже, чем у zk-tech, поэтому стоимость транзакции немного выше, чем у zk-rollup.
- Оптимистичная модель требует льготного периода для оспаривания, что означает, что транзакции выполняются немного медленнее, чем в zk-свертке.
Однако оптимистичные свертки намного превосходят сайдчейны в обоих этих аспектах.

#### Типичный флоу:

1. Пользователь отправляет транзакцию развертывания смарт-контракта вне сети агрегатору (производителю блоков в этой конструкции).
2. Агрегатор локально развертывает транзакцию, создавая новый смарт-контракт.
3. Агрегатор вычисляет новый корень состояния
4. Затем создает транзакцию Ethereum, которая содержит этот корень состояния, рассчитанный на шаге 3.
5. Любой пользователь, увидевший, что агрегатор развертывает недопустимый корень состояния (созданный путем включения недействительных транзакций), может бросить вызов агрегатору, опубликовав действительный корень состояния вместе с доказательствами, необходимыми для его подтверждения, удалив часть цепочки и агрегатора-мошенника, + любого, построившего блоки поверх мошеннического, за вознаграждение.
6. После фиксации недопустимого блока и окончательного подтверждения мошенничества цепочка на уровне 2 может быть откатана и возобновлена с предыдущего блока, не связанного с мошенничеством.

#### Плюсы:
- Гибкость в обобщенных вычислениях (Turing-complete/EVM-совместимость)
- Увеличение масштабируемости (от 200 до 2000 транзакций в секунду по сравнению с текущими 10 транзакциями в секунду на уровне 1 Ethereum)
- Все данные доступны в сети (нет необходимости доверять сторонним поставщикам данных)
- Лучший UX

#### Минусы:
- Ограниченная пропускная способность по сравнению с некоторыми другими решениями уровня 2 (Plasma, ZK Rollups и т.д.)
- Возникают некоторые дополнительные проблемы безопасности. Для того чтобы Optimistic Rollups работали, мы должны надеятся, что существует большинство честных валидаторов Ethereum (майнеры в Eth1, стейкеры в Eth2) и что есть по крайней мере один агрегатор, который не подвергает цензуре транзакции.
- Риск фронт-рана(на пятом шаге, но можно нивелировать через submarine-sends. Чуть ниже техника. Но не только)

Submarine commit транзакции переносят ценность и скрыты в большом наборе анонимных данных: для всех, кроме отправителя, транзакция-коммит неотличима от отправки эфира (или токенов) на новый адрес, который не использовался в цепочке Ethereum до этого. В традиционной схеме коммитов транзакция коммита может привести к утечке не только адресата коммита, но и суммы отправляемых денег, что само по себе станет фронтраном.

Вместо одной общедоступной (и, следовательно, подверженной фронт-рану) транзакции транзакция-коммит содержит криптографическую "слепок" любых конкретных данных приложения, которые пользователь хотел отправить в смарт-контракт, а также блокирует любой связанный эфир или токены в адресе submarine, неотличимом от нового адреса. Благодаря некоторой криптографической магии любое значение, заблокированное по этому адресу, может быть разблокировано только с помощью смарт-контракта. Привязывая стоимость к транзакции-коммиту (которая сгорает, если пользователь не раскрывает ее), можно создать механизмы, не позволяющие злоумышленнику выборочно раскрывать коммиты. Как только транзакция-коммит безопасно включена в цепочку блоков, пользователь раскрывает свой слепок в смарт-контракте, и смарт-контракт выполняет свою специфическую для приложения [логику](https://github.com/lorenzb/libsubmarine)

O2 роллапы - это следующая веха в развитии этого семейства протоколов. Ключевое отличие заключается в том, где именно хранятся данные. В Optimistic Rollup все данные публикуются в сети по умолчанию как данные вызовов. В O2 Rollup данные публикуются вне сети только в том случае, если валидатор инициирует вызов DA(т.е. данные вне сети не хешируются, чтобы соответствовать опубликованному корню).

Хотя разница незначительна, влияние довольно велико. Публикация данных вне сети по умолчанию позволяет O2 Rollup достичь следующего:
- Неограниченная масштабируемость, поскольку для публикации корня Merkle требуется всего одна небольшая транзакция.
- Возможность работы с гораздо более сложными приложениями, где данные довольно дороги (например, сделки IDEX составляют ~ 2 КБ данных).

#### Cводная: 

* Оptimistic/ Все данные о транзакциях отправляются в сеть как данные о вызовах; стоимость газа, связанная с моментом публикации. Сеть валидатора обрабатывает данные и активирует доказательство мошенничества в случае возникновения проблемы <- теоретический потокол в Эфириуме в районе 2.5к

* O2/ Транзакции публикуются вне сети (бесплатно), если только валидаторы не обнаружат проблему с доступностью данных. Сеть валидатора обрабатывает данные и активирует доказательство мошенничества в случае возникновения проблемы; Проблема доступности данных вынуждает передавать данные на блокчейн <- потенциально неограниченное скалирование

Опираясь на эти свойства О2 могут стать востребованны в реальных бизнес-кейсах:

* Платежны системы в точках продаж — O2 Rollup позволяет поставщику услуг поддерживать платежи, не связанные с хранением, с помощью масштабируемой сети, которая может соответствовать пропускной способности Visa. Провайдер может гарантировать мгновенные переводы для быстрого времени оформления заказа без риска сбоя расчета.
* Активы видеоигр. Ключом к NFT является право собственности. Независимо от того, существует ли это право собственности на L1 или L2, для игроков и разработчиков игр не имеет большого значения. Размещение игровых активов в O2 Rollup L2 позволяет играм поддерживать мгновенные бесплатные передачи и высокую пропускную способность. Разработчики также могут не платить комиссию за минтинг, если/пока пользователь не решит вывести средства на L1.
* Brave Browser. Микроплатежи зависят от высокой пропускной способности и низкой стоимости, чтобы быть жизнеспособными. Использование O2 Rollup позволит Brave распространять токены BAT без затрат на газ для своих пользователей. Переводы осуществляются мгновенно, и пользователи платят комиссию только за их продажу.

[ZK Rollups vs Optimistic Rollups](https://blog.idex.io/all-posts/rollup-rundown)

[A New Way to Scale - Optimized Optimistic Rollup](https://blog.idex.io/all-posts/o2-rollup-overview)

[Optimistic vs. ZK Rollup: Deep Dive](https://medium.com/matter-labs/optimistic-vs-zk-rollup-deep-dive-ea141e71e075)


## Plasma

Plasma — это решение для масштабирования уровня 2, первоначально предложенное Джозефом Пуном и Виталиком Бутериным в их статье [Plasma: Scalable Autonomous Smart Contracts]((https://plasma.io/plasma.pdf))

Plasma построена с использованием смарт-контрактов, деревьев Меркла и ряда криптографических проверок, что позволяет создавать неограниченное количество дочерних цепочек, которые, по сути, являются уменьшенными копиями родительского блокчейна Ethereum. Каждая сеть спроектирована так, чтобы работать по-своему, обслуживая различные потребности, сосуществуя и работая независимо друг от друга. Поверх каждой дочерней цепочки можно создать больше цепочек, и это то, что создает древовидную структуру. Вместе они обеспечивают быстрые и дешевые транзакции, выгружая транзакции из основного блокчейна Ethereum в «боковую» цепочку. Эти боковые цепи периодически отчитываются перед основной цепью и используют ее для разрешения любых споров.

Мотивация(со слов Виталика Бутерина):
"Это «плохая идея» встраивать сложные функции в базовый уровень блокчейна, это создаст высокий уровень накладных расходов на управление, поскольку платформе придется постоянно обсуждать, внедрять и координировать недавно обнаруженные технические улучшения. Трудоемкая задача по добавлению новой функции в базовый протокол может привести к стагнации Ethereum. Мы не должны полагаться только на изменения в базовом протоколе для продолжения развития Эфириума. Я действительно думаю, что по мере того, как блокчейны становятся все более и более зрелыми, уровень 1 обязательно стабилизируется, а уровень 2 будет брать на себя все больше и больше бремени текущих инноваций и изменений"

Депозиты и снятие средств цепи Plasma с переходами состояний валидируются proof of fraud(обычно надстройки над PoW, PoS, PoA). Это также позволяет обрабатывать большее количество транзакций с меньшей загрузкой данных на базовой платформе. Любой пользователь может отправить средства другому(даже в другом поддереве).Доказательства мошенничества гарантируют, что в случае злонамеренной активности пользователи смогут сообщать о нечестных узлах, защищать свои средства и выходить из транзакции (что предполагает взаимодействие с основной цепочкой). Другими словами, доказательства мошенничества используются как механизм, с помощью которого дочерняя цепочка подает жалобу в свою родительскую цепь(даже на Л1).

Эти доказательства используют интерактивный протокол вывода средств. Для вывода определенной суммы средств необходимо время выхода. Выходящая сторона должна подтвердить вывод через модель UTXO, запросив вывод средств. Затем участники сети могут представить связанное доказательство, которое необходимо подтвердить и проверить, были ли потрачены какие-либо средства. Если событие оказывается ошибочным, оно считается мошенническим и подтверждение отменяется. Со временем еще один связанный раунд позволяет осуществить вывод, связывая состояние до зафиксированной временной метки. Участники могут быстро выйти из неправильной цепочки Plasma. В случае атаки участники могут быстро выйти и уменьшить свои расходы, обеспечив безопасность внутри системы.

#### Плюсы:
- Plasma поможет масштабировать блокчейн Ethereum, перенеся операции "наружу"
- Более низкие комиссии и более быстрые операции также позволяют приложениям с интенсивными вычислениями работать на блокчейне.
- Устранение значительного объема ненужных данных в основной цепочке, что также снижает пропускную способность обработки узлов.
- Он совместим с различными решениями для масштабирования в цепочке, такими как шардинг, различные размеры блоков и т. д.

#### Минусы:
- Plasma требует централизованного компонента для работы, поскольку компонент вне сети управляется властями.
- Долгие периоды ожидания (7-14 дней) для пользователей, желающих вывести свои средства
- Плохой опыт для пользователей, у которых нет большого количества активов и которые не хотят ждать недели, чтобы получить к ним доступ.
- Новые риски/проблемы безопасности (в первую очередь для выходов), которые необходимо устранить для обеспечения неизменности и непрерывности.

В дополнение каждое конкретное решение может иметь свой набор недостатков: Plasmа MVP имеет ограничения по времени, не является идеальным пользовательским интерфейсом и уязвим к перегрузке сети. Plasma Cash полагается на невзаимозаменяемые токены (NFT) для работы, что требует большой истории транзакций и тд

Ходовые версии протокола: Plasma Cash, Plasma Debit, Plasma Prime, MVP (Minimum Viable Plasma)

#### Почитать:

[Plasma Group](https://plasma.group/)

[What is Ethereum Plasma](https://academy.binance.com/en/articles/what-is-ethereum-plasma)

[The State of Plasma](https://media.consensys.net/the-state-of-plasma-1-6b48c1e4b295)

[How Plasma Work](https://medium.com/applicature/what-is-plasma-and-how-does-it-work-15641c95825f)

[Learn Plasma](https://www.learnplasma.org/en/learn/framework.html)

[Comparing plasma models](https://www.learnplasma.org/en/learn/compare.html)


## Шардинг

Разделение еще больше ослабляет требование ко всем узлам основной цепи загружать все данные, но вместо этого использует новый примитив, известный как доказательства DA, для достижения более высокой масштабируемости. С доказательствами DA вместо того, чтобы все узлы загружали все данные из каждого сегмента, каждый узел загружает только небольшую часть данных цепочки сегментов, зная, что меньшинство из них может коллективно реконструировать все блоки цепочки сегментов. Это обеспечивает общую безопасность между сегментами, поскольку гарантирует, что любой отдельный узел цепочки сегментов может вызывать споры для разрешения всеми узлами по требованию. Polkadot и Near уже реализовали доказательства DA в своем дизайне шардинга, и это также будет принято в ETH 2.0.

Стоит упомянуть, чем дорожная карта сегментирования ETH 2.0 отличается от других. Хотя первоначальная дорожная карта Ethereum заключалась в том, чтобы выполнять сегментирование, как и в Polkadot, похоже, что недавно он переключился только на сегментирование данных. Другими словами, шарды в Ethereum будут служить слоями DA для роллапов, которые, в свою очередь, будут выполнять все операции. Это означает, что Ethereum по-прежнему будет иметь единое состояние, как и сегодня. Напротив, Polkadot выполняет все операции на базовом уровне, где каждый сегмент имеет свое состояние.

Основным преимуществом использования шардов в качестве слоев данных является гибкость свертывания для создания среза данных на нескольких шардах, оставаясь при этом полностью компонуемым. Таким образом, роллап может иметь пропускную способность и коммиссии, не ограниченные емкостью данных одного сегмента. Ожидается, что с 64 сегментами максимальная совокупная пропускная способность сверток увеличится с 5к транзакций в секунду до 100к транзакций в секунду. Напротив, независимо от того, какую пропускную способность генерирует Polkadot в целом, сборы будут связаны ограниченной пропускной способностью одного парачейна (1000-1500 TPS).

Но шардинг только данных имеет ограничение для вычислительно тяжелых операций, будь то облачные вычисления, слабые ИИ и далее по списку. К каждой задаче следует подбирать свой инструмент

## Специализированные слои DA

Специализированные слои DA — это новейшая форма модульного дизайна блокчейна. Они используют базовую идею уровня DA ETH 2.0, но в другом направлении. Новаторским проектом на этом фронте является Celestia и более новые решения, такие как Polygon Avail(также движется в этом направлении)

Подобно шардам DA ETH 2.0, Celestia действует как базовый уровень, к которому могут подключаться другие цепочки (свертки), чтобы унаследовать безопасность. Решение Celestia отличается от Ethereum по двум фундаментальным причинам:
1\ не происходит никакого значимого исполнения на базовом уровне (как это делает ETH 2.0). Это освобождает роллапы от крайне ненадежных комиссий базового уровня, которые в среде с отслеживанием состояния могут резко возрасти в любое время, будь то размещение и аукционы токенов, раздачи NFT или возможности высокодоходного фарминга. Роллапы потребляют одни и те же ресурсы (байты на базовом уровне) для обеспечения безопасности и только для обеспечения безопасности. Эта особенность позволяет привязывать плату за использование к конкретному роллапу вместо базового уровня.
Celestia может увеличить пропускную способность DA без шардинга благодаря доказательствам DA. Ключевым свойством доказательств DA является то, что чем больше узлов участвует в выборке, тем больше данных может быть сохранено, за счет выполнения дополнительной коллективной работы. В контексте Celestia это означает, что блоки могут быть увеличены (более высокая пропускная способность), поскольку в выборке DA участвует больше легких узлов (без централизации).
Как и все архитектуры, специализированные слои DA также имеют некоторые издержки. Одним из непосредственных недостатков является отсутствие слоя расчетов по умолчанию, слоя транзакций верхнего уровня. Таким образом, чтобы обмениваться активами друг с другом, накопительные пакеты должны будут реализовать методы для интерпретации доказательств мошенничества друг друга.

## Промежуточный Вывод

Мы оценили различные архитектуры блокчейна, включая монолитные цепи, хабы, роллапы, сегментированные цепочки и специализированные уровни DA. Учитывая их относительно простую инфраструктуру, широкие пространство для проектирования и возможность горизонтального расширения, в текущее время, что многоцепочечные хабы лучше всего подходят для удовлетворения неотложных потребностей блокчейна. В долгосрочной перспективе, учитывая эффективность использования ресурсов и уникальные свойства масштабируемости, специализированные уровни DA вполне могут стать их потеснить

### Примечание о каналах(state-, payment-, commit-channels) и сайдчейнах. Как о архитектурных примитивах 

Каналы состояния(state-channels) — это очень распространенный и простой способ представить взаимодействия с блокчейном, но вместо вычисления средствами бч осуществляться за его пределами, без значительного увеличения риска для любого участника. Наиболее известным примером этой стратегии является идея платежных каналов в биткойнах(Lightning Network Bitcoin), которые позволяют осуществлять мгновенные бесплатные платежи напрямую между двумя сторонами.
Каналы состояния очень похожи на концепцию платежных каналов в сети, но вместо поддержки только платежей(в эфириуме Raiden, Kchannels) они также поддерживают общие «обновления состояния». Помещая на бч только результат вычислений без комиссий за пользование сетью. ENS домены или [СеlerX Perun](https://statechannels.org/)

#### Флоу:
1. Часть состояния блокчейна заблокирована с помощью мультиподписи или какого-то смарт-контракта, так что определенный набор участников должен полностью согласиться друг с другом, чтобы обновить его.
2. Участники обновляют состояние между собой, создавая и подписывая транзакции, которые могут быть отправлены в блокчейн, но вместо этого просто удерживаются на данный момент. Каждое новое обновление «превосходит» предыдущие обновления.
3. Наконец, участники отправляют состояние обратно в блокчейн, который закрывает канал состояния и снова разблокирует состояние (обычно в конфигурации, отличной от исходной).

#### Плюсы:
- Сильная конфиденциальность и приватность
- Мгновенная финализация

#### Минусы:
- Необходима 100% достижимость участников. 
- Каналы состояния лучше всего использовать для приложений с определенным набором участников - контракт, используемый для блокировки состояния всегда должен знать участников и сущности (т.е. адреса), которые являются частью данного канала. Возможно добавлять и удалять людей, но это требует каждый раз измененять контракт. Тогда как в сайдчейнах такого ограничения на перемещение участников нет.

Каналы состояния особенно полезны, когда участники будут обмениваться множеством обновлений состояния в течение длительного периода времени: это связано с тем, что создание канала при развертывании депозитного контракта штата сопряжено с первоначальными затратами. Но после его развертывания стоимость обновления состояния внутри этого канала становится чрезвычайно низкой.


## Sidechains

Это совместимые с Ethereum независимые блокчейны, которые используют свои собственные модели консенсуса и параметры блоков для эффективной обработки транзакций. Контракты обычно переносимы, а активы и данные пробрасываются с помощью state-каналов и мостов. Публичные сайдчейны полезны во многих различных контекстах, включая микротранзакции, stable-транзакции и транзакции конкретных приложений(искусство на основе NFT, голосование DAO, валюта сообщества и тд.).
Чтобы обеспечить собственную безопасность в сайдчейнах наравне с PoW, PoS, PoA консенсусами применяются и различные методы Byzantine Fault Tolerant для обеспечения консенсуса. Примеры включают Peppermint BFT, используемый сетью Matic, и Asynchronous Binary Byzantine Agreement от Skale.

Совместимость(Interoperability)/ Возможность перемещать активы и данные между цепочками — важный аспект среды c сайдчейнами. Приложения используют боковые цепи для быстрых и недорогих транзакций, но результаты этих транзакций должны легко передаваться между цепочками. Это иногда называют двусторонней привязкой. Поскольку блокчейны независимы друг от друга, ресурсы обычно блокируются в одной цепочке и чеканятся (создаются) в другой. При переносе обратно они сжигаются(уничтожаются) и разблокируются.
[TokenBridge](https://github.com/poanetwork/tokenbridge) иллюстрирует эту архитектуру. Смарт-контракты, развернутые в обеих сетях, связаны мостовым оракулом, где валидаторы моста подтверждают и подписывают межсетевые транзакции. 
Skale, Matic, xDai также хорошие примеры

#### Плюсы:
- Сайдчейны перманентны(если их поддерживать). И не нужно создавать отдельные цепочки для каждого нового участника или новой задачи. Каналы Райден частично обходят эту проблему путем создания меш-сетки между участниками создавая канал между вами и получателем через посредника(общего для вас)
- Сайдчейны позволяют взаимодействовать различным механикам и активам в обобщенном виде

#### Минусы:
- Сайдчейны не выигрывают от безопасности основной цепи. Пользователь, взаимодействующий с боковой цепью, должен доверять свойствам безопасности этой цепи, потому что, если она скомпрометирована или злонамеренна, у пользователя нет гарантии выхода в основную цепь. *участники канала состояния всегда могут вернуться в основную цепочку, если они следуют протоколу.
- Сайдчейны требуют больших первоначальных инвестиций: чтобы создать сайдчейн, нам нужно иметь достаточное количество майнеров, чтобы сеть была защищена от злоумышленников. Кроме того, мы должны убедиться, что они работают. В то время как в каналах состояния нет задействованного блокчейна. Таким образом, такое требование не имеет смысла.
- Федерализация протокола необходима для боковых цепей: это добавляет еще один слой между основной цепью и боковой цепью. Это может оказаться еще одним слабым местом для атаки злоумышленников путем подкупа или нападения на федерацию. В то время как в каналах нам просто нужен смарт-контракт, чтобы сделать работу за нас.

#### Почитать:

[State Channels - an explanation](https://www.jeffcoleman.ca/state-channels/)

[Making Sense of Ethereum's Layer 2 Scaling Solutions (Josh Stark)](https://medium.com/l4-media/making-sense-of-ethereums-layer-2-scaling-solutions-state-channels-plasma-and-truebit-22cb40dcc2f4)

[State Channels Blog](https://blog.statechannels.org/)

[Enabling Blockchain Innovations with Pegged Sidechains](https://blockstream.com/sidechains.pdf)

[Sidechain technologies in blockchain networks: An examination and state-of-the-art review](https://www.sciencedirect.com/science/article/pii/S1084804519303315)

Сommit-чейны/ это база для plasma.

https://eprint.iacr.org/2019/360.pdf

https://eprint.iacr.org/2018/642.pdf

https://liquidity.network/research